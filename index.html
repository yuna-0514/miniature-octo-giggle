<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ˜ŸåŸŸåŸè³ªï¼šé›²ç«¯å…±é³´è§€æ¸¬å„€</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;700&family=Noto+Sans+TC:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #05070a;
            color: white;
            overflow-x: hidden;
        }
        .serif { font-family: 'Noto Serif TC', serif; }
        .glass {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(72, 52, 212, 0.3); border-radius: 10px; }
        @keyframes pulse-slow {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 0.6; }
        }
        .animate-pulse-slow { animation: pulse-slow 3s infinite; }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4 relative">

    <!-- å®‡å®™èƒŒæ™¯ -->
    <div class="absolute inset-0 opacity-20 pointer-events-none">
        <div class="absolute top-0 left-0 w-full h-full" style="background: radial-gradient(circle at 50% 50%, #4834d4 0%, transparent 70%);"></div>
    </div>

    <div id="app" class="w-full max-w-xl z-10">
        <!-- åˆå§‹è¼‰å…¥æç¤º -->
        <div class="text-center animate-pulse text-indigo-400 tracking-widest">ç³»çµ±å•Ÿå‹•ä¸­...</div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";

        // å…¨åŸŸç‹€æ…‹
        let state = {
            view: 'start',
            name: '',
            currentQ: 0,
            scoreE: 0,
            isSaving: false,
            user: null,
            logs: []
        };

        // Firebase æœå‹™å¯¦ä¾‹
        let db, auth;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'cosmic-quiz-v5';
        const googleSheetUrl = "https://script.google.com/macros/s/AKfycbzsffAQD5mEX_8hXcxLECHzaceLhKlrDQA6RbeFH88LpSicUDIeEh9mJCumyFU3EYYt7A/exec"; 

        // åˆå§‹åŒ– Firebase (åŠ å…¥éŒ¯èª¤ä¿è­·)
        try {
            const configText = typeof __firebase_config !== 'undefined' ? __firebase_config : '{}';
            const firebaseConfig = JSON.parse(configText);
            
            if (firebaseConfig.apiKey) {
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                onAuthStateChanged(auth, (u) => {
                    if (!u) {
                        signInAnonymously(auth).catch(e => console.error("Auth Error", e));
                    } else {
                        state.user = u;
                    }
                });
            }
        } catch (e) {
            console.error("Firebase Initialization Failed:", e);
        }

        // æ¸¬é©—é¡Œç›®
        const questions = [
            { q: "åœ¨æ˜Ÿéš›ç¤¾äº¤å ´åˆä¸­ï¼Œä½ å‚¾å‘æ–¼ï¼Ÿ", a: "ä¸»å‹•èˆ‡å¤šå€‹æ˜Ÿç³»å»ºç«‹é€£çµ (E)", b: "å¾…åœ¨ç†Ÿæ‚‰çš„å¼•åŠ›è»Œé“å…§ (I)" },
            { q: "é¢å°çªç™¼çš„è®Šæ•…ï¼Œä½ çš„éˆé­‚ç›´è¦ºæ˜¯ï¼Ÿ", a: "ç‡ƒç‡’ç†±æƒ…å¼•é ˜ç¾¤é«” (E)", b: "å†·éœåˆ†ææœ€ä½³å‡ºå£ (I)" },
            { q: "å¦‚ä½•æ¢å¾©ä½ çš„å¿ƒéˆèƒ½é‡ï¼Ÿ", a: "å‰å¾€ç†±é¬§çš„æ†æ˜Ÿå¸‚å ´ (E)", b: "å›åˆ°éœè¬çš„å€‹äººè¡Œæ˜Ÿ (I)" },
            { q: "é¢å°æœªçŸ¥ä»»å‹™ï¼Œä½ çš„åæ‡‰æ˜¯ï¼Ÿ", a: "ç«‹åˆ»ç™¼å°„å•Ÿå‹•ä¿¡è™Ÿ (E)", b: "æ ¡å°èˆªåœ–æ•¸æ“šå†å‡ºç™¼ (I)" },
            { q: "å°æ–¼æˆç‚ºç„¦é»ï¼Œä½ çš„æ„Ÿå—æ˜¯ï¼Ÿ", a: "ç²å¾—èƒ½é‡å……æ»¿æ„Ÿ (E)", b: "æ„Ÿåˆ°ä¿¡è™Ÿè¢«å¹²æ“¾ (I)" },
            { q: "æƒ…ç·’è¡¨é”æ–¹å¼æ¥è¿‘å“ªç¨®ï¼Ÿ", a: "è¶…æ–°æ˜Ÿçˆ†ç™¼ (E)", b: "æ˜Ÿé›²ç·©æ…¢æµè½‰ (I)" },
            { q: "ç¾¤é«”å”ä½œæ™‚ï¼Œä½ å‚¾å‘ï¼Ÿ", a: "æ“”ä»»æ³¢å‹•ä¸»å°è€… (E)", b: "æ“”ä»»ç©©å®šæ”¯æ´è€… (I)" },
            { q: "èšæœƒçµæŸå¾Œçš„éœé»˜æ„Ÿï¼Ÿ", a: "æ„Ÿåˆ°æ¯ç«­æ¸´æœ›å†é€£ç·š (E)", b: "æ„Ÿåˆ°æ¥µåº¦èˆ’é©å›æ­¸æœ¬è³ª (I)" },
            { q: "å°é™Œç”Ÿäººçš„æœ¬èƒ½çœ‹æ³•ï¼Ÿ", a: "æ½›åœ¨çš„æ–°é€£çµ (E)", b: "éœ€è§£æçš„æœªçŸ¥ç¢¼ (I)" },
            { q: "ä½ çš„ç”Ÿå‘½ç¯€å¥è½èµ·ä¾†åƒï¼Ÿ", a: "æ¿€æ˜‚çš„äº¤éŸ¿æ¨‚ (E)", b: "æ‚ é çš„èƒŒæ™¯éŸ³ (I)" },
            { q: "å–œæ­¡çš„å·¥ä½œæ¨¡å¼ï¼Ÿ", a: "å¤šç·šç¨‹å³æ™‚äº’å‹• (E)", b: "å–®ç·šç¨‹æ²ˆæµ¸é–‹ç™¼ (I)" },
            { q: "æƒ…ç·’å—å£“æ™‚ï¼Œä½ æœƒï¼Ÿ", a: "å°å¤–å°‹æ±‚ä¿¡è™Ÿå‚¾è¨´ (E)", b: "é—œé–‰å‚³è¼¸è‡ªè¡Œæ¶ˆåŒ– (I)" },
            { q: "å¤–äººçš„ç¬¬ä¸€çœ¼è§€æ¸¬å°è±¡ï¼Ÿ", a: "ç†±æƒ…æ´‹æº¢ (E)", b: "ç¥ç¥•æ²ˆç©© (I)" },
            { q: "å°æ–¼ã€Œå†’éšªã€çš„å®šç¾©ï¼Ÿ", a: "æ“´å¼µç‰ˆåœ–çš„å¿…è¦ (E)", b: "å¢åŠ é¢¨éšªçš„è®Šé‡ (I)" },
            { q: "åœ˜éšŠä»»å‹™ç«™ä½ï¼Ÿ", a: "èˆ¹é ­é ˜èˆª (E)", b: "æ“æ§å°èˆª (I)" },
            { q: "åšæ±ºå®šä¸»è¦ä¾æ“šï¼Ÿ", a: "ç›´è¦ºèˆ‡åé¥‹ (E)", b: "é‚è¼¯èˆ‡æº–å‰‡ (I)" },
            { q: "åå¥½çš„ç”Ÿå‘½é«”é©—ï¼Ÿ", a: "é‚Šåšé‚Šæƒ³ (E)", b: "ä¸‰æ€å¾Œè¡Œ (I)" },
            { q: "åˆ†äº«ç”Ÿæ´»é»æ»´æ™‚ï¼Ÿ", a: "é€™æ˜¯ä¸€ç¨®èƒ½é‡æµå‹• (E)", b: "é€™æ˜¯ä¸€ç¨®èƒ½é‡æ¶ˆè€— (I)" },
            { q: "éˆé­‚çš„ç†æƒ³ç‹€æ…‹ï¼Ÿ", a: "èåˆèˆ‡å»£å¤§ (E)", b: "ç¨ç«‹èˆ‡æ·±é‚ƒ (I)" },
            { q: "è¦æŠŠä½ æ¯”ä½œä¸€å€‹ç¾è±¡ï¼Ÿ", a: "æ†æ˜Ÿè¼»å°„ (E)", b: "ä¸­å­æ˜Ÿå¼•åŠ› (I)" }
        ];

        function render() {
            const container = document.getElementById('app');
            if (!container) return;

            if (state.view === 'start') {
                container.innerHTML = `
                    <div class="glass p-12 rounded-[40px] text-center shadow-2xl">
                        <div class="text-5xl mb-8 animate-pulse-slow text-indigo-400">âœ§</div>
                        <h1 class="text-4xl font-bold tracking-[0.3em] mb-4 serif">æ˜ŸåŸŸåŸè³ª</h1>
                        <p class="text-[10px] tracking-[0.5em] text-gray-500 uppercase mb-12">éˆé­‚é »ç‡èˆ‡é›²ç«¯åŒæ­¥ç³»çµ±</p>
                        <input id="nameInput" value="${state.name}" placeholder="è¼¸å…¥éˆé­‚ä»£ç¢¼" 
                            class="w-full bg-transparent border-b border-gray-800 py-3 text-center text-2xl mb-12 focus:outline-none focus:border-indigo-500 transition-all placeholder:text-gray-800">
                        <button id="startBtn" class="w-full py-5 rounded-full font-bold tracking-[0.2em] bg-indigo-600 hover:bg-indigo-500 transition-all shadow-lg shadow-indigo-500/20">
                            é–‹å•Ÿè§€æ¸¬
                        </button>
                    </div>
                `;
                document.getElementById('nameInput').oninput = (e) => state.name = e.target.value;
                document.getElementById('startBtn').onclick = handleStart;
            } else if (state.view === 'quiz') {
                const q = questions[state.currentQ];
                container.innerHTML = `
                    <div class="glass p-8 rounded-[40px]">
                        <div class="flex justify-between items-center mb-10">
                            <div class="w-full h-1 bg-gray-900 rounded-full mr-4 overflow-hidden">
                                <div class="h-full bg-indigo-500 transition-all duration-300" style="width: ${((state.currentQ + 1) / 20) * 100}%"></div>
                            </div>
                            <span class="text-[10px] font-mono text-gray-500">${String(state.currentQ + 1).padStart(2, '0')}/20</span>
                        </div>
                        <h2 class="text-xl leading-relaxed mb-12 min-h-[6rem] serif">${q.q}</h2>
                        <div class="space-y-4">
                            <button id="ansA" class="w-full p-5 bg-white/5 border border-white/5 rounded-2xl text-left text-sm hover:border-indigo-500/50 transition-all hover:bg-white/10">${q.a}</button>
                            <button id="ansB" class="w-full p-5 bg-white/5 border border-white/5 rounded-2xl text-left text-sm hover:border-indigo-500/50 transition-all hover:bg-white/10">${q.b}</button>
                        </div>
                    </div>
                `;
                document.getElementById('ansA').onclick = () => handleAnswer(1);
                document.getElementById('ansB').onclick = () => handleAnswer(0);
            } else if (state.view === 'result') {
                const isE = state.scoreE >= 11;
                container.innerHTML = `
                    <div class="glass p-8 rounded-[40px]">
                        ${state.isSaving ? `
                            <div class="py-20 text-center animate-pulse tracking-widest text-indigo-400">æ­£åœ¨åŒæ­¥éˆé­‚æ•¸æ“šè‡³æ˜Ÿåœ–èˆ‡è©¦ç®—è¡¨...</div>
                        ` : `
                            <div class="text-center mb-10 pb-6 border-b border-white/5">
                                <h2 class="text-3xl mb-2 tracking-widest serif">${state.name}</h2>
                                <p class="text-xs font-bold text-yellow-500 tracking-[0.3em] uppercase">
                                    ${isE ? "è¶…å¤§è³ªé‡æ†æ˜Ÿ (Big Fire E)" : "ä¸­å­æ˜Ÿå¼•åŠ›æ ¸å¿ƒ (Void I)"}
                                </p>
                            </div>
                            <div class="grid grid-cols-1 gap-4 mb-10">
                                ${renderResultCard("å‹æƒ…å…±æŒ¯", "âœ¦", "text-indigo-300", isE ? "ä½ æ˜¯ç¾¤é«”ä¸­çš„å¼•åŠ›ä¸­å¿ƒï¼Œç†±æƒ…èƒ½é©…æ•£å‘¨åœçš„å¯’å†·ã€‚" : "ä½ è¿½æ±‚è³ªé‡æ–¼é‡çš„å…±æŒ¯ï¼Œä¸€æ—¦é€£çµä¾¿æ˜¯è·¨è¶Šæ™‚ç©ºçš„é‡åŠ›é€£çµã€‚")}
                                ${renderResultCard("æ„›æƒ…æ¥µå…‰", "â™¥", "text-rose-400", isE ? "æ„›å¦‚è¶…æ–°æ˜Ÿçˆ†ç™¼ç†±çƒˆï¼Œè¿½æ±‚çµ•å°åŒæ­¥ã€‚" : "æ„›æ˜¯æ²ˆç©©çš„å¼•åŠ›ã€‚åœ¨éœè¬ä¸­èˆ‡å°æ–¹é »ç‡åˆä¸€ï¼Œå°±æ˜¯ä½ çš„æµªæ¼«ã€‚")}
                                ${renderResultCard("è¡€è„ˆé‡åŠ›", "âš“", "text-emerald-400", isE ? "å®¶åº­ä¸­çš„å¤ªé™½ï¼Œä¸»å‹•è² è²¬èˆ‡è¦åŠƒã€‚" : "å®¶åº­æœ€å®‰å¿ƒçš„å¾Œç›¾ï¼Œä½ çš„å­˜åœ¨å°±æ˜¯ç©©å›ºåŸºçŸ³ã€‚")}
                                <div class="p-5 bg-indigo-900/10 rounded-2xl border border-indigo-500/20">
                                    <h4 class="text-amber-300 text-xs font-bold mb-2 flex items-center uppercase tracking-wider"><span class="mr-2 text-base">ğŸ“œ</span> æ˜Ÿéˆè«­æ—¨</h4>
                                    <p class="text-xs text-gray-300 italic leading-relaxed">
                                        ${isE ? "ã€Œå¼·å…‰æœ‰æ™‚æœƒæ©è“‹ç´°ç¯€ã€‚å­¸æœƒå®‰éœï¼Œä½ å°‡çœ‹è¦‹éš±è—åœ¨é»‘æš—ä¸­çš„å¥‡è¹Ÿã€‚ã€" : "ã€Œåˆ¥å®³æ€•ç™¼å°„ä¿¡è™Ÿã€‚å®‡å®™æµ©ç€šï¼Œç¸½æœ‰äººåœ¨ç­‰å¾…æ¥æ”¶ä½ ç¨ç‰¹çš„æ³¢é•·ã€‚ã€"}
                                    </p>
                                </div>
                            </div>
                            <button id="rebootBtn" class="w-full text-center text-[10px] text-gray-600 hover:text-white transition-all uppercase tracking-widest">
                                é‡å•Ÿç³»çµ±è§€æ¸¬ / REBOOT SYSTEM
                            </button>
                        `}
                    </div>
                `;
                const btn = document.getElementById('rebootBtn');
                if (btn) btn.onclick = () => location.reload();
            } else if (state.view === 'adminAuth') {
                container.innerHTML = `
                    <div class="glass p-12 rounded-[40px] text-center">
                        <h2 class="text-xl mb-8 text-red-500 tracking-widest uppercase serif">Security Protocol</h2>
                        <input type="password" id="adminKeyInput" placeholder="è¼¸å…¥å­˜å–é‡‘é‘°" class="w-full bg-gray-900 border border-gray-800 p-4 rounded-xl text-white mb-8 text-center focus:outline-none">
                        <button id="verifyBtn" class="w-full py-4 bg-red-900/20 text-red-500 rounded-xl border border-red-900/50 hover:bg-red-900/40">åŸ·è¡Œé©—è­‰</button>
                    </div>
                `;
                document.getElementById('verifyBtn').onclick = () => {
                    if (document.getElementById('adminKeyInput').value === 'admin123') {
                        state.view = 'adminBoard';
                        render();
                        startAdminListener();
                    } else { alert('é©—è­‰å¤±æ•—'); }
                };
            } else if (state.view === 'adminBoard') {
                container.innerHTML = `
                    <div class="glass p-8 rounded-[40px]">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-lg text-indigo-400 serif">é›²ç«¯è§€æ¸¬æ—¥èªŒ</h2>
                            <button id="exitAdmin" class="text-[10px] text-gray-500 border border-gray-800 px-3 py-1 rounded hover:text-white transition-all">EXIT</button>
                        </div>
                        <div class="max-h-96 overflow-y-auto pr-2 custom-scrollbar">
                            <table class="w-full text-[10px] text-gray-400 text-left">
                                <thead class="border-b border-white/10 text-indigo-300/50 uppercase">
                                    <tr><th class="py-3">æ™‚é–“</th><th>ä»£ç¢¼</th><th class="text-right">é¡å‹</th></tr>
                                </thead>
                                <tbody>
                                    ${state.logs.map(log => `
                                        <tr class="border-b border-white/5">
                                            <td class="py-3 text-gray-600">${new Date(log.timestamp).toLocaleDateString()}</td>
                                            <td class="text-indigo-300 font-bold">${log.name}</td>
                                            <td class="text-right">${log.result.split(' ')[0]}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
                document.getElementById('exitAdmin').onclick = () => location.reload();
            }
        }

        function renderResultCard(title, icon, colorClass, text) {
            return `<div class="p-5 bg-white/5 rounded-2xl border border-white/5">
                <h4 class="${colorClass} text-xs font-bold mb-2 flex items-center tracking-wider"><span class="mr-2 text-base">${icon}</span> ${title}</h4>
                <p class="text-xs text-gray-400 leading-relaxed">${text}</p>
            </div>`;
        }

        function handleStart() {
            if (!state.name.trim()) return;
            state.view = state.name === 'access::void::99' ? 'adminAuth' : 'quiz';
            render();
        }

        function handleAnswer(p) {
            state.scoreE += p;
            if (state.currentQ + 1 < questions.length) {
                state.currentQ++;
                render();
            } else { finishQuiz(); }
        }

        async function finishQuiz() {
            state.view = 'result';
            state.isSaving = true;
            render();

            const isE = state.scoreE >= 11;
            const resultType = isE ? "Eå‹ (æ†æ˜Ÿ)" : "Iå‹ (ä¸­å­æ˜Ÿ)";
            const payload = {
                name: state.name,
                result: resultType,
                score: state.scoreE,
                timestamp: Date.now()
            };

            // 1. åŒæ­¥åˆ° Firebase (å¦‚æœæœ‰åˆå§‹åŒ–æˆåŠŸ)
            if (db) {
                try {
                    const col = collection(db, 'artifacts', appId, 'public', 'data', 'quizLogs');
                    await addDoc(col, payload);
                } catch (e) { console.error("Firebase Sync Error", e); }
            }

            // 2. åŒæ­¥åˆ° Google è©¦ç®—è¡¨
            if (googleSheetUrl) {
                try {
                    await fetch(googleSheetUrl, {
                        method: 'POST',
                        mode: 'no-cors',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                } catch (e) { console.error("Google Sheet Sync Error", e); }
            }

            state.isSaving = false;
            render();
        }

        function startAdminListener() {
            if (!db) return;
            const col = collection(db, 'artifacts', appId, 'public', 'data', 'quizLogs');
            onSnapshot(col, (snap) => {
                state.logs = snap.docs.map(d => ({ id: d.id, ...d.data() })).sort((a,b)=>b.timestamp - a.timestamp);
                render();
            }, (err) => console.error("Admin Listener Error", err));
        }

        // å•Ÿå‹•æ¸²æŸ“
        render();
    </script>
</body>
</html>
