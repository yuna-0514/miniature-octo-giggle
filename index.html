<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>éˆé­‚é »ç‡ï¼šç”Ÿæ´»æ€§æ ¼è§€æ¸¬å„€</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;700&family=Noto+Sans+TC:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #05070a;
            color: white;
            overflow-x: hidden;
        }
        .serif { font-family: 'Noto Serif TC', serif; }
        .glass {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(72, 52, 212, 0.3); border-radius: 10px; }
        @keyframes pulse-slow {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 0.6; }
        }
        .animate-pulse-slow { animation: pulse-slow 3s infinite; }
        .option-btn:active { transform: scale(0.98); background: rgba(255, 255, 255, 0.15); }
        
        /* ç°¡å–®çš„æ·¡å…¥å‹•ç•« */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in { animation: fadeIn 0.5s ease-out forwards; }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4 relative">

    <!-- å®‡å®™èƒŒæ™¯ -->
    <div class="absolute inset-0 opacity-20 pointer-events-none">
        <div class="absolute top-0 left-0 w-full h-full" style="background: radial-gradient(circle at 50% 50%, #4834d4 0%, transparent 70%);"></div>
    </div>

    <div id="app" class="w-full max-w-xl z-10">
        <!-- åˆå§‹è¼‰å…¥æç¤º -->
        <div class="text-center animate-pulse text-indigo-400 tracking-widest">ç³»çµ±å•Ÿå‹•ä¸­...</div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // å…¨åŸŸç‹€æ…‹
        let state = {
            view: 'start',
            name: '',
            currentQ: 0,
            scoreE: 0,
            isSaving: false,
            feedbackSent: false,
            user: null,
            logs: []
        };

        // Firebase æœå‹™å¯¦ä¾‹
        let db, auth;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'cosmic-quiz-v7';
        const googleSheetUrl = "https://script.google.com/macros/s/AKfycbzsffAQD5mEX_8hXcxLECHzaceLhKlrDQA6RbeFH88LpSicUDIeEh9mJCumyFU3EYYt7A/exec"; 

        // åˆå§‹åŒ– Firebase
        const initFirebase = async () => {
            try {
                const configText = typeof __firebase_config !== 'undefined' ? __firebase_config : '{}';
                const firebaseConfig = JSON.parse(configText);
                
                if (firebaseConfig.apiKey) {
                    const app = initializeApp(firebaseConfig);
                    auth = getAuth(app);
                    db = getFirestore(app);

                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } else {
                        await signInAnonymously(auth);
                    }

                    onAuthStateChanged(auth, (u) => {
                        state.user = u;
                        if (u && state.view === 'adminBoard') {
                            startAdminListener();
                        }
                    });
                }
            } catch (e) {
                console.error("Firebase Initialization Failed:", e);
            }
        };

        initFirebase();

        // é¡Œç›®è¨­è¨ˆ
        const questionsSource = [
            {
                q: "çµ‚æ–¼ç­‰åˆ°é€±æœ«äº†ï¼Œä½ é€šå¸¸æœƒæ€éº¼å®‰æ’ï¼Ÿ",
                options: [
                    { text: "è·Ÿä¸€å¤§ç¾¤æœ‹å‹å»å”±æ­Œã€åƒé£¯æˆ–æ´¾å°ï¼Œè¶Šç†±é¬§è¶Šå¥½", score: 3 },
                    { text: "ç´„ä¸€å…©å€‹çŸ¥å¿ƒå¥½å‹å»å’–å•¡å»³èŠèŠå¤©", score: 2 },
                    { text: "ä¸€å€‹äººå»æ›¸åº—é€›é€›ï¼Œæˆ–å»å…¬åœ’æ•£æ­¥", score: 1 },
                    { text: "å®…åœ¨å®¶è£¡è¿½åŠ‡ã€æ‰“é›»å‹•ï¼Œå®Œå…¨ä¸æƒ³å‡ºé–€", score: 0 }
                ]
            },
            {
                q: "å‰›åˆ°ä¸€å€‹å……æ»¿é™Œç”Ÿäººçš„æ–°ç’°å¢ƒï¼ˆå¦‚æ–°ç­ç´šã€æ–°å…¬å¸ï¼‰ï¼Œä½ æœƒï¼Ÿ",
                options: [
                    { text: "ä¸»å‹•è·Ÿæ¯å€‹äººæ‰“æ‹›å‘¼ï¼Œäº¤æ›è¯çµ¡æ–¹å¼", score: 3 },
                    { text: "å…ˆè§€å¯Ÿæ°£æ°›ï¼Œæœ‰äººè·Ÿæˆ‘å°åˆ°çœ¼å†è¬›è©±", score: 2 },
                    { text: "åªè·Ÿçœ‹èµ·ä¾†æ¯”è¼ƒå‹å–„çš„ä¸€å…©å€‹äººè¬›è©±", score: 1 },
                    { text: "é»˜é»˜æ‰¾å€‹è§’è½æˆ–æ˜¯æ»‘æ‰‹æ©Ÿï¼Œé¿å…çœ¼ç¥æ¥è§¸", score: 0 }
                ]
            },
            {
                q: "å¿ƒæƒ…ä½è½æˆ–æ˜¯å£“åŠ›å¾ˆå¤§çš„æ™‚å€™ï¼Œä½ é€šå¸¸æœƒï¼Ÿ",
                options: [
                    { text: "ç«‹åˆ»æ‰¾æœ‹å‹å‡ºä¾†å¤§åè‹¦æ°´ï¼Œç™¼æ´©æƒ…ç·’", score: 3 },
                    { text: "åœ¨ç¤¾ç¾¤åª’é«”ä¸Šç™¼æ–‡ï¼Œæˆ–æ˜¯å‚³è¨Šæ¯çµ¦å¥½å‹", score: 2 },
                    { text: "æˆ´ä¸Šè€³æ©Ÿè½éŸ³æ¨‚ï¼Œæˆ–æ˜¯å‡ºé–€èµ°èµ°æ²ˆæ¾±ä¸€ä¸‹", score: 1 },
                    { text: "æŠŠè‡ªå·±é—œåœ¨æˆ¿é–“è£¡ç¡è¦ºæˆ–æ”¾ç©ºï¼Œä¸æƒ³èªªè©±", score: 0 }
                ]
            },
            {
                q: "æœ‹å‹èšæœƒä¸­ï¼Œå¦‚æœå‡ºç¾å†·å ´æˆ–å°·å°¬çš„æ²ˆé»˜ï¼Œä½ æœƒï¼Ÿ",
                options: [
                    { text: "å—ä¸äº†å®‰éœï¼Œé¦¬ä¸Šæ‰¾è©±é¡Œä¾†ç‚’ç†±æ°£æ°›", score: 3 },
                    { text: "æœƒè©¦è‘—æ¥è©±ï¼Œä½†ä¸ä¸€å®šæœƒç•¶é‚£å€‹ä¸»å°è€…", score: 2 },
                    { text: "æœƒç¨å¾®è§€å¯Ÿä¸€ä¸‹å¤§å®¶çš„è¡¨æƒ…ï¼Œå¦‚æœæ²’äººèªªè©±å°±ç¹¼çºŒä¿æŒå®‰éœ", score: 1 },
                    { text: "è¦ºå¾—å®‰éœä¹Ÿæ²’é—œä¿‚ï¼Œé †å…¶è‡ªç„¶", score: 0 }
                ]
            },
            {
                q: "åœ¨å·¥ä½œæˆ–åˆ†çµ„è¨è«–æ™‚ï¼Œä½ çš„è§’è‰²é€šå¸¸æ˜¯ï¼Ÿ",
                options: [
                    { text: "ä¸»å‹•ç™¼è¡¨æ„è¦‹ï¼Œä¸¦å¼•å°å¤§å®¶è¨è«–çš„æ–¹å‘", score: 3 },
                    { text: "æœƒé©æ™‚è£œå……æƒ³æ³•ï¼Œæ”¯æŒåˆ¥äººçš„æ„è¦‹", score: 2 },
                    { text: "å¤šæ•¸æ™‚é–“åœ¨è½ï¼Œæœ€å¾Œæ‰ç¸½çµæˆ–æ˜¯ä¸ç™¼è¨€", score: 1 },
                    { text: "å‚¾å‘ç¨è‡ªå®Œæˆåˆ†é…åˆ°çš„éƒ¨åˆ†ï¼Œä¸å–œæ­¡é–‹æœƒ", score: 0 }
                ]
            },
            {
                q: "å°æ–¼ã€Œæˆç‚ºçœ¾äººç„¦é»ã€ï¼ˆä¾‹å¦‚ä¸Šå°é ˜çæˆ–è¡¨æ¼”ï¼‰ï¼Œä½ çš„æ„Ÿè¦ºæ˜¯ï¼Ÿ",
                options: [
                    { text: "éå¸¸äº«å—ï¼Œè¦ºå¾—é€™æ˜¯å±•ç¾è‡ªå·±çš„å¥½æ©Ÿæœƒ", score: 3 },
                    { text: "é›–ç„¶æœ‰é»ç·Šå¼µï¼Œä½†å¿ƒè£¡é‚„æ˜¯æœ‰é»é–‹å¿ƒçš„", score: 2 },
                    { text: "ä¸æ’æ–¥ï¼Œä½†å¦‚æœæ˜¯åƒä¸Šå°å ±å‘Šé€™ç¨®æœ‰æº–å‚™çš„æ¯”è¼ƒå¥½ï¼Œè‡¨æ™‚è¢«é»åæœƒæƒ³èº²", score: 1 },
                    { text: "èƒ½é¿å°±é¿ï¼Œè¦ºå¾—éå¸¸ä¸è‡ªåœ¨", score: 0 }
                ]
            },
            {
                q: "åƒåŠ å®Œä¸€å ´å¤§å‹ç¤¾äº¤æ´»å‹•ï¼ˆå¦‚å©šç¦®ã€å°¾ç‰™ï¼‰å¾Œï¼Œä½ çš„ç‹€æ…‹æ˜¯ï¼Ÿ",
                options: [
                    { text: "è¦ºå¾—æ„çŒ¶æœªç›¡ï¼Œé‚„æƒ³çºŒæ”¤", score: 3 },
                    { text: "è¦ºå¾—é‚„ä¸éŒ¯ï¼Œä½†å·®ä¸å¤šè©²å›å®¶ä¼‘æ¯äº†", score: 2 },
                    { text: "ç•¶ä¸‹è¦ºå¾—é‚„å¥½ï¼Œä½†å›åˆ°å®¶å¾Œæœƒçªç„¶è¦ºå¾—ä¸æƒ³å†è¬›è©±äº†", score: 1 },
                    { text: "è¦ºå¾—ç²¾ç¥è¢«æç©ºï¼Œéœ€è¦ç«‹åˆ»å›å®¶ç¨è™•å……é›»", score: 0 }
                ]
            },
            {
                q: "ä½ æ¯”è¼ƒå®¹æ˜“è¨˜ä½æ–°æœ‹å‹çš„ä»€éº¼ç‰¹å¾µï¼Ÿ",
                options: [
                    { text: "ä»–çš„åå­—ã€é•·ç›¸å’Œä»–ç•¶æ™‚èªªçš„å¥½ç¬‘ç¬‘è©±", score: 3 },
                    { text: "è¨˜å¾—æˆ‘å€‘èŠéçš„è©±é¡Œå…§å®¹ï¼Œä½†åå­—å¯èƒ½è¦å°ä¸€ä¸‹", score: 2 },
                    { text: "èŠå¤©çš„æ°›åœå’Œä»–çµ¦äººçš„æ„Ÿè¦º", score: 1 },
                    { text: "ä¸å¤ªå®¹æ˜“è¨˜ä½é™Œç”Ÿäººï¼Œé™¤éæœ‰æ·±åº¦äº¤æµ", score: 0 }
                ]
            },
            {
                q: "é‡åˆ°å›°é›£éœ€è¦åšæ±ºå®šæ™‚ï¼Œä½ ç¿’æ…£ï¼Ÿ",
                options: [
                    { text: "è¶•å¿«å•å¤§å®¶çš„æ„è¦‹ï¼Œé€éè¨è«–ä¾†é‡æ¸…", score: 3 },
                    { text: "å…ˆå•å¹¾å€‹ä¿¡ä»»çš„äººï¼Œå†è‡ªå·±åšæ±ºå®š", score: 2 },
                    { text: "æœƒå…ˆä¸Šç¶²æŸ¥è³‡æ–™æˆ–çœ‹è©•è«–ï¼Œç›¡é‡ä¸éº»ç…©åˆ¥äºº", score: 1 },
                    { text: "è‡ªå·±é—œèµ·é–€ä¾†åˆ†æåˆ©å¼Šï¼Œæƒ³æ¸…æ¥šå†èªª", score: 0 }
                ]
            },
            {
                q: "å¦‚æœæœ‰ä¸€å€‹é€±æœ«å®Œå…¨æ²’æœ‰ä»»ä½•è¡Œç¨‹ï¼Œä½ æœƒï¼Ÿ",
                options: [
                    { text: "è¦ºå¾—å¾ˆæ…Œï¼Œè¶•å¿«å‚³è¨Šæ¯å•æœ‹å‹è¦ä¸è¦å‡ºä¾†", score: 3 },
                    { text: "è¦ºå¾—æœ‰é»ç„¡èŠï¼Œå¯èƒ½æœƒå»é€›é€›è¡—", score: 2 },
                    { text: "æœƒæƒ³åšé»æœ‰ç”Ÿç”¢åŠ›çš„äº‹ï¼Œæ¯”å¦‚æ•´ç†æˆ¿é–“æˆ–å­¸é»æ±è¥¿ï¼Œä¸ä¸€å®šè¦å‡ºé–€", score: 1 },
                    { text: "è¦ºå¾—å¤ªæ£’äº†ï¼çµ‚æ–¼å¯ä»¥å¥½å¥½äº«å—ç¨è™•æ™‚å…‰", score: 0 }
                ]
            },
            {
                q: "åœ¨è·¯ä¸Šé‡åˆ°ä¸å¤ªç†Ÿçš„åŒäº‹æˆ–åŒå­¸ï¼Œä½ æœƒï¼Ÿ",
                options: [
                    { text: "å¤§è²æ‰“æ‹›å‘¼ï¼Œä¸¦åœä¸‹ä¾†é–’èŠå¹¾å¥", score: 3 },
                    { text: "æœƒåœä¸‹ä¾†ç°¡å–®å¯’æš„å¹¾å¥ï¼Œå•å•æœ€è¿‘å¥½ä¸å¥½", score: 2 },
                    { text: "å¾®ç¬‘é»é ­ç¤ºæ„ï¼Œç„¶å¾Œç¹¼çºŒèµ°", score: 1 },
                    { text: "å‡è£æ²’çœ‹åˆ°æˆ–ä½é ­æ»‘æ‰‹æ©Ÿï¼Œé¿å…å°·å°¬", score: 0 }
                ]
            },
            {
                q: "ä½ å–œæ­¡çš„ç”Ÿæ´»ç¯€å¥æ˜¯ï¼Ÿ",
                options: [
                    { text: "è¡Œç¨‹æ»¿æª”ï¼Œæ¯å¤©éƒ½æœ‰æ–°é®®äº‹", score: 3 },
                    { text: "å‹•éœçš†å®œï¼Œæœ‰èšæœƒä¹Ÿæœ‰ç¨è™•", score: 2 },
                    { text: "é›–ç„¶å–œæ­¡è¦å¾‹ï¼Œä½†å¶çˆ¾æœ‰äº›å°é©šå–œä¹Ÿä¸éŒ¯", score: 1 },
                    { text: "è¦å¾‹ç©©å®šï¼Œä¸å–œæ­¡å¤ªå¤šçªç™¼ç‹€æ³", score: 0 }
                ]
            },
            {
                q: "è·Ÿåˆ¥äººèªªè©±æ™‚ï¼Œä½ çš„ç¿’æ…£æ˜¯ï¼Ÿ",
                options: [
                    { text: "é‚Šæƒ³é‚Šèªªï¼Œæƒ³åˆ°ä»€éº¼å°±è¬›ä»€éº¼", score: 3 },
                    { text: "çœ‹ç†Ÿä¸ç†Ÿï¼Œç†Ÿçš„è©±å°±éœ¹å“©å•ªæ‹‰è¬›ï¼Œä¸ç†Ÿå°±è¬¹æ…ä¸€é»", score: 2 },
                    { text: "æœƒå…ˆåœ¨è…¦ä¸­çµ„ç¹”å¥½èªè¨€ï¼Œå†èªªå‡ºå£", score: 1 },
                    { text: "è©±å¾ˆå°‘ï¼Œé€šå¸¸æ˜¯ç”¨ç°¡çŸ­çš„å¥å­å›æ‡‰", score: 0 }
                ]
            },
            {
                q: "å°æ–¼åˆ†äº«è‡ªå·±çš„ç§ç”Ÿæ´»ï¼ˆå¦‚ç™¼é™æ™‚å‹•æ…‹ï¼‰ï¼Ÿ",
                options: [
                    { text: "å¾ˆæ¨‚æ„åˆ†äº«ï¼Œå¹¾ä¹æ¯å¤©éƒ½æœƒç™¼å¥½å¹¾å‰‡", score: 3 },
                    { text: "å¶çˆ¾é‡åˆ°ç‰¹åˆ¥çš„äº‹æƒ…æ‰æœƒç™¼", score: 2 },
                    { text: "å¾ˆå°‘ç™¼ï¼Œæˆ–æ˜¯åªç™¼çµ¦æ‘¯å‹çœ‹", score: 1 },
                    { text: "å®Œå…¨ä¸ç™¼ï¼Œæ³¨é‡éš±ç§", score: 0 }
                ]
            },
            {
                q: "ç•¶ä½ åœ¨å°ˆæ³¨åšä¸€ä»¶äº‹æ™‚ï¼Œæœ‰äººä¾†æ‰¾ä½ èŠå¤©ï¼Ÿ",
                options: [
                    { text: "æ²’é—œä¿‚ï¼Œæ­£å¥½ä¼‘æ¯ä¸€ä¸‹èŠèŠå¤©", score: 3 },
                    { text: "æœƒå…ˆæ‡‰ä»˜å¹¾å¥ï¼Œå†çœ‹æƒ…æ³çµæŸå°è©±", score: 2 },
                    { text: "é›–ç„¶ä¸æœƒç”Ÿæ°£ï¼Œä½†æœƒå¸Œæœ›èƒ½å¿«é»çµæŸå°è©±å›åˆ°å·¥ä½œä¸Š", score: 1 },
                    { text: "è¦ºå¾—è¢«æ‰“æ“¾å¾ˆç…©èºï¼Œå¸Œæœ›èƒ½è¶•å¿«çµæŸ", score: 0 }
                ]
            },
            {
                q: "ä½ å–œæ­¡çš„é‹å‹•æˆ–ä¼‘é–’æ´»å‹•é¡å‹é€šå¸¸æ˜¯ï¼Ÿ",
                options: [
                    { text: "ç±ƒçƒã€ç¾½çƒç­‰åœ˜é«”æˆ–é›™äººç«¶æŠ€é‹å‹•", score: 3 },
                    { text: "è·Ÿæœ‹å‹ä¸€èµ·å»å¥èº«æˆ¿æˆ–çˆ¬å±±", score: 2 },
                    { text: "åƒåŠ åœ˜é«”èª²ç¨‹ï¼ˆå¦‚ç‘œä¼½ç­ï¼‰ï¼Œé›–ç„¶æ˜¯ä¸€èµ·åšä½†ä¸ç”¨å¤ªå¤šäº¤æµ", score: 1 },
                    { text: "æ…¢è·‘ã€æ¸¸æ³³ã€é–±è®€ç­‰å¯ä»¥è‡ªå·±å®Œæˆçš„æ´»å‹•", score: 0 }
                ]
            },
            {
                q: "å¦‚æœè¦å»æ—…è¡Œï¼Œä½ åå¥½ï¼Ÿ",
                options: [
                    { text: "è·Ÿä¸€å¤§ç¾¤æœ‹å‹åŒ…æ£Ÿæ°‘å®¿ï¼Œæ™šä¸Šä¸€èµ·çƒ¤è‚‰", score: 3 },
                    { text: "è·Ÿä¼´ä¾¶æˆ–é–¨èœœå…©ä¸‰å€‹äººçš„æ·±åº¦æ—…éŠ", score: 2 },
                    { text: "è·Ÿå®¶äººå»å®šé»åº¦å‡ï¼Œä¸ç”¨ä¸€ç›´è·‘è¡Œç¨‹", score: 1 },
                    { text: "ä¸€å€‹äººçš„èƒŒåŒ…å®¢æ—…è¡Œï¼Œäº«å—æµæµªçš„æ„Ÿè¦º", score: 0 }
                ]
            },
            {
                q: "é›»è©±éŸ¿äº†ï¼Œçœ‹åˆ°æ˜¯ä¸ç†Ÿçš„è™Ÿç¢¼ï¼Œä½ æœƒï¼Ÿ",
                options: [
                    { text: "ç›´æ¥æ¥èµ·ä¾†ï¼Œå¥½å¥‡æ˜¯èª°æ‰¾æˆ‘", score: 3 },
                    { text: "æœƒçŒ¶è±«ä¸€ä¸‹ï¼Œæƒ³èªªæ˜¯å¿«éé‚„æ˜¯å¤–é€æ‰æ¥", score: 2 },
                    { text: "ç›¯è‘—è¢å¹•çœ‹å¾ˆä¹…ï¼Œå¿ƒè£¡ç³¾çµè¦ä¸è¦æ¥ï¼Œæœ€å¾Œé€šå¸¸æ²’æ¥", score: 1 },
                    { text: "ç›´æ¥æ›æ–·æˆ–ä¸ç†æœƒï¼Œç„¶å¾Œå»Googleè™Ÿç¢¼", score: 0 }
                ]
            },
            {
                q: "ä½ è¦ºå¾—å“ªå¥è©±æ¯”è¼ƒåƒä½ ï¼Ÿ",
                options: [
                    { text: "æˆ‘æ˜¯å¤§å®¶çš„é–‹å¿ƒæœï¼Œæœ‰æˆ‘åœ¨å°±ä¸ç„¡èŠ", score: 3 },
                    { text: "æˆ‘æ˜¯ä¸€å€‹å¾ˆå¥½çš„å”èª¿è€…ï¼Œå–œæ­¡åœ¨åœ˜é«”ä¸­å¹«å¿™é€£çµå¤§å®¶", score: 2 },
                    { text: "æˆ‘æ˜¯ä¸€å€‹å¾ˆå¥½çš„å‚¾è½è€…ï¼Œæœ‹å‹å–œæ­¡æ‰¾æˆ‘èŠå¿ƒäº‹", score: 1 },
                    { text: "æˆ‘æ˜¯ä¸€å€‹å®‰éœçš„è§€å¯Ÿè€…ï¼Œå–œæ­¡åœ¨ä¸€æ—çœ‹è‘—å¤§å®¶", score: 0 }
                ]
            },
            {
                q: "æœ€å¾Œï¼Œä½ è¦ºå¾—è‡ªå·±çš„èƒ½é‡ä¾†æºæ›´åƒï¼Ÿ",
                options: [
                    { text: "å¤ªé™½ï¼šå‘å¤–è¼»å°„å…‰èŠ’ï¼Œæº«æš–ä»–äºº", score: 3 },
                    { text: "æœˆäº®ï¼šåå°„å…‰èŠ’ï¼Œæº«æŸ”ä¸”å¤šè®Š", score: 2 },
                    { text: "å±±è„ˆï¼šç©©é‡ä¸”å®‰éœï¼Œè®“äººæœ‰ä¾é æ„Ÿ", score: 1 },
                    { text: "æ·±æµ·ï¼šæ·±é‚ƒå¹³éœï¼Œè˜Šå«å¼·å¤§å…§åœ¨åŠ›é‡", score: 0 }
                ]
            }
        ];

        // æ·±æ‹·è²ä¸¦éš¨æ©Ÿæ‰“äº‚æ¯å€‹å•é¡Œçš„é¸é …é †åº
        let questions = JSON.parse(JSON.stringify(questionsSource));
        questions.forEach(q => {
            for (let i = q.options.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [q.options[i], q.options[j]] = [q.options[j], q.options[i]];
            }
        });

        function render() {
            const container = document.getElementById('app');
            if (!container) return;

            if (state.view === 'start') {
                container.innerHTML = `
                    <div class="glass p-12 rounded-[40px] text-center shadow-2xl">
                        <div class="text-5xl mb-8 animate-pulse-slow text-indigo-400">âœ§</div>
                        <h1 class="text-3xl font-bold tracking-[0.2em] mb-4 serif">æ€§æ ¼åŸè³ªè§€æ¸¬å„€</h1>
                        <p class="text-[12px] tracking-[0.3em] text-gray-400 uppercase mb-12">æ¢å°‹ä½ çš„éˆé­‚é »ç‡èˆ‡æœ¬è³ª</p>
                        <input id="nameInput" value="${state.name}" placeholder="è«‹è¼¸å…¥æ‚¨çš„æš±ç¨±" 
                            class="w-full bg-transparent border-b border-gray-800 py-3 text-center text-xl mb-12 focus:outline-none focus:border-indigo-500 transition-all placeholder:text-gray-700">
                        <button id="startBtn" class="w-full py-5 rounded-full font-bold tracking-[0.2em] bg-indigo-600 hover:bg-indigo-500 transition-all shadow-lg shadow-indigo-500/20">
                            é–‹å§‹åˆ†æ
                        </button>
                    </div>
                `;
                document.getElementById('nameInput').oninput = (e) => state.name = e.target.value;
                document.getElementById('startBtn').onclick = handleStart;
                
                document.getElementById('nameInput').addEventListener('keypress', function (e) {
                    if (e.key === 'Enter') {
                        handleStart();
                    }
                });

            } else if (state.view === 'quiz') {
                const q = questions[state.currentQ];
                
                const optionsHtml = q.options.map((opt, idx) => `
                    <button class="option-btn w-full p-4 bg-white/5 border border-white/5 rounded-2xl text-left text-sm hover:border-indigo-500/50 transition-all hover:bg-white/10 mb-3 leading-relaxed flex items-center group" onclick="handleAnswer(${opt.score})">
                        <span class="mr-3 opacity-30 text-xs group-hover:opacity-100 transition-opacity">â—†</span> ${opt.text}
                    </button>
                `).join('');

                container.innerHTML = `
                    <div class="glass p-8 rounded-[40px]">
                        <div class="flex justify-between items-center mb-4">
                            <div class="w-full h-1 bg-gray-900 rounded-full mr-4 overflow-hidden">
                                <div class="h-full bg-indigo-500 transition-all duration-300" style="width: ${((state.currentQ + 1) / questions.length) * 100}%"></div>
                            </div>
                            <span class="text-[10px] font-mono text-gray-500">${String(state.currentQ + 1)}/${questions.length}</span>
                        </div>
                        
                        <div class="text-center mb-6">
                            <p class="text-[10px] text-indigo-300/60 tracking-[0.2em] uppercase">è«‹æ†‘ç›´è¦ºé¸æ“‡ â€¢ é¸é …éš¨æ©Ÿæ’åˆ—</p>
                        </div>

                        <h2 class="text-lg font-medium leading-relaxed mb-8 min-h-[4rem] serif tracking-wide">${q.q}</h2>
                        <div class="flex flex-col">
                            ${optionsHtml}
                        </div>
                    </div>
                `;
            } else if (state.view === 'result') {
                const isE = state.scoreE >= 30;
                
                container.innerHTML = `
                    <div class="glass p-8 rounded-[40px] max-h-[85vh] overflow-y-auto custom-scrollbar">
                        ${state.isSaving ? `
                            <div class="py-20 text-center animate-pulse tracking-widest text-indigo-400">æ­£åœ¨ç”Ÿæˆæ·±åº¦åˆ†æå ±å‘Š...</div>
                        ` : `
                            <div class="text-center mb-6 pb-4 border-b border-white/5">
                                <h2 class="text-2xl mb-2 tracking-widest serif">${state.name}</h2>
                                <p class="text-sm font-bold text-indigo-400 tracking-[0.2em] uppercase">
                                    è§€æ¸¬çµæœï¼š${isE ? "å¤–å‘èƒ½é‡ä¸»å° (E)" : "å…§å‘é »ç‡ä¸»å° (I)"}
                                </p>
                            </div>

                            <!-- æº–ç¢ºåº¦å›é¥‹å€ (ç§»è‡³ä¸Šæ–¹) -->
                            <div class="mb-8 p-5 bg-indigo-900/30 rounded-2xl border border-indigo-500/30 text-center">
                                <h4 class="text-indigo-200 text-xs font-bold mb-4 tracking-wider">ç³»çµ±æ ¡æº–ï¼šæ­¤åˆ†æçµæœæº–ç¢ºå—ï¼Ÿ</h4>
                                ${state.feedbackSent ? 
                                    `<div class="py-2 text-xs text-green-400 tracking-widest flex items-center justify-center bg-green-500/10 rounded-lg animate-fade-in">
                                        <span class="mr-2">âœ“</span> å›é¥‹å·²è¨˜éŒ„
                                    </div>` :
                                    `<div class="flex justify-center space-x-2">
                                        <button onclick="sendFeedback('æº–ç¢º')" class="flex-1 py-3 bg-indigo-600 hover:bg-indigo-500 text-white rounded-xl text-xs font-bold tracking-widest transition-all shadow-lg shadow-indigo-500/20">æº–ç¢º</button>
                                        <button onclick="sendFeedback('æ™®é€š')" class="flex-1 py-3 bg-white/10 hover:bg-white/20 text-gray-300 rounded-xl text-xs font-bold tracking-widest transition-all">æ™®é€š</button>
                                        <button onclick="sendFeedback('ä¸æº–')" class="flex-1 py-3 bg-white/10 hover:bg-white/20 text-gray-300 rounded-xl text-xs font-bold tracking-widest transition-all">ä¸æº–</button>
                                    </div>
                                    <p class="text-[9px] text-gray-500 mt-2 tracking-wider animate-pulse">* è«‹å®Œæˆå›é¥‹ä»¥è§£é–é‡æ¸¬åŠŸèƒ½</p>`
                                }
                            </div>

                            <div class="space-y-6">
                                ${renderResultCard("æ€§æ ¼ç‰¹è³ªè§£æ", "ğŸ”", "text-indigo-300", 
                                    isE ? "ä½ åƒæ˜¯ä¸€é¡†æ†æ˜Ÿï¼Œé€éèˆ‡å¤–ç•Œçš„ç¢°æ’å’Œé€£çµä¾†ç”¢ç”Ÿèƒ½é‡ã€‚ä½ ç†±æ„›æºé€šï¼Œåœ¨äººç¾¤ä¸­èƒ½æ„Ÿåˆ°è‡ªåœ¨ï¼Œä¸¦ä¸”æ“…é•·å°‡ç†±æƒ…å‚³éçµ¦èº«é‚Šçš„äººã€‚ä½ å°æ–°äº‹ç‰©å……æ»¿å¥½å¥‡ï¼Œä¸¦å‹‡æ–¼è¸å‡ºèˆ’é©åœˆã€‚" : 
                                    "ä½ åƒæ˜¯ä¸€å€‹æ·±é‚ƒçš„æ˜Ÿç³»ï¼Œé€éå…§å¿ƒçš„æ€è€ƒèˆ‡æ²ˆæ¾±ä¾†ç´¯ç©èƒ½é‡ã€‚ä½ é›–ç„¶åœ¨ç¤¾äº¤å ´åˆå¯èƒ½è¼ƒç‚ºå®‰éœï¼Œä½†ä½ æ“æœ‰æ¥µå¼·çš„æ´å¯ŸåŠ›èˆ‡è±å¯Œçš„å…§å¿ƒä¸–ç•Œã€‚ä½ è¿½æ±‚æ·±åº¦è€Œéå»£åº¦ï¼Œå°ä¿¡ä»»çš„äººæœ‰è‘—æ¥µé«˜çš„å¿ èª åº¦ã€‚")}
                                
                                ${renderResultCard("äººéš›é—œä¿‚å»ºè­°", "ğŸ¤", "text-rose-400", 
                                    isE ? "ä½ çš„äººè„ˆå»£æ³›ï¼Œä½†æœ‰æ™‚æœƒå› ç‚ºå¤ªå¿«æŠ•å…¥è€Œå¿½ç•¥ç´°ç¯€ã€‚å»ºè­°å¶çˆ¾çµ¦è‡ªå·±ä¸€æ®µéœé»˜çš„æ™‚é–“ï¼Œå­¸ç¿’å‚¾è½å…§å¿ƒæ·±è™•çš„è²éŸ³ï¼Œé€™æœƒè®“ä½ çš„æ±ºç­–æ›´æœ‰åŠ›é‡ã€‚" : 
                                    "ä½ æ“æœ‰è®“äººå®‰å¿ƒçš„æ²ˆç©©åŠ›é‡ã€‚å»ºè­°å¯ä»¥è©¦è‘—åœ¨å®‰å…¨çš„ç’°å¢ƒä¸‹ä¸»å‹•åˆ†äº«ä½ çš„æƒ³æ³•ï¼Œå®‡å®™ä¸­æœ‰å¾ˆå¤šæ­£åœ¨å°‹æ±‚ä½ æ™ºæ…§çš„äººï¼Œé©åº¦çš„é€£çµæœƒè®“ä½ ç™¼ç¾æ–°çš„å¥‘æ©Ÿã€‚")}

                                ${renderResultCard("æ ¸å¿ƒå„ªå‹¢", "âš¡", "text-emerald-400", 
                                    isE ? "æ¥µå¼·çš„æºé€šå”èª¿èƒ½åŠ›ã€é©æ‡‰æ–°ç’°å¢ƒçš„é€Ÿåº¦ã€é¼“èˆå£«æ°£çš„é ˜å°åŠ›ã€‚" : 
                                    "æ•éŠ³çš„è§€å¯Ÿèˆ‡åˆ†æã€å°ˆæ³¨ä¸”æ·±åº¦çš„æ€è€ƒèƒ½åŠ›ã€æƒ…ç·’ç¨ç«‹ä¸”ç©©å›ºã€‚")}
                            </div>

                            ${state.feedbackSent ? `
                                <button id="rebootBtn" class="w-full mt-10 py-4 text-center text-[10px] text-gray-500 border border-gray-800 rounded-full hover:text-white hover:border-white transition-all uppercase tracking-widest animate-fade-in">
                                    é‡æ–°æ¸¬è©¦ / RESTART
                                </button>
                            ` : ''}
                        `}
                    </div>
                `;
                const btn = document.getElementById('rebootBtn');
                if (btn) btn.onclick = () => location.reload();
            } else if (state.view === 'adminAuth') {
                container.innerHTML = `
                    <div class="glass p-12 rounded-[40px] text-center">
                        <h2 class="text-xl mb-8 text-red-500 tracking-widest uppercase serif">Security Protocol</h2>
                        <input type="password" id="adminKeyInput" placeholder="è¼¸å…¥å­˜å–é‡‘é‘°" class="w-full bg-gray-900 border border-gray-800 p-4 rounded-xl text-white mb-8 text-center focus:outline-none">
                        <button id="verifyBtn" class="w-full py-4 bg-red-900/20 text-red-500 rounded-xl border border-red-900/50 hover:bg-red-900/40">åŸ·è¡Œé©—è­‰</button>
                    </div>
                `;
                document.getElementById('verifyBtn').onclick = () => {
                    if (document.getElementById('adminKeyInput').value === 'admin123') {
                        state.view = 'adminBoard';
                        render();
                        startAdminListener();
                    } else { alert('é©—è­‰å¤±æ•—'); }
                };
            } else if (state.view === 'adminBoard') {
                container.innerHTML = `
                    <div class="glass p-8 rounded-[40px]">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-lg text-indigo-400 serif">è§€æ¸¬æ•¸æ“šç¸½è¦½</h2>
                            <button id="exitAdmin" class="text-[10px] text-gray-500 border border-gray-800 px-3 py-1 rounded hover:text-white transition-all">EXIT</button>
                        </div>
                        <div class="max-h-96 overflow-y-auto pr-2 custom-scrollbar">
                            <table class="w-full text-[10px] text-gray-400 text-left">
                                <thead class="border-b border-white/10 text-indigo-300/50 uppercase">
                                    <tr>
                                        <th class="py-3 text-right">æ™‚é–“</th>
                                        <th class="pl-4">å§“å</th>
                                        <th>çµæœ</th>
                                        <th>åˆ†æ•¸</th>
                                        <th>ç²¾æº–åº¦</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${state.logs.map(log => `
                                        <tr class="border-b border-white/5">
                                            <td class="py-3 text-right text-gray-600 font-mono">${new Date(log.timestamp).toLocaleString('zh-TW', {month:'numeric', day:'numeric', hour:'2-digit', minute:'2-digit'})}</td>
                                            <td class="pl-4 text-indigo-300 font-bold">${log.name}</td>
                                            <td>${log.result}</td>
                                            <td class="font-mono text-gray-400">${log.score}</td>
                                            <td class="${log.accuracy === 'æº–ç¢º' ? 'text-green-400' : (log.accuracy === 'ä¸æº–' ? 'text-red-400' : 'text-gray-500')}">${log.accuracy || 'æœªå¡«'}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
                document.getElementById('exitAdmin').onclick = () => location.reload();
            }
        }

        function renderResultCard(title, icon, colorClass, text) {
            return `<div class="p-6 bg-white/5 rounded-2xl border border-white/5">
                <h4 class="${colorClass} text-sm font-bold mb-3 flex items-center tracking-wider"><span class="mr-2 text-lg">${icon}</span> ${title}</h4>
                <p class="text-sm text-gray-400 leading-relaxed">${text}</p>
            </div>`;
        }

        function handleStart() {
            if (!state.name.trim()) return;
            state.view = state.name === 'admin::99' ? 'adminAuth' : 'quiz';
            if (state.view === 'quiz') {
                 questions = JSON.parse(JSON.stringify(questionsSource));
                 questions.forEach(q => {
                    for (let i = q.options.length - 1; i > 0; i--) {
                        const j = Math.floor(Math.random() * (i + 1));
                        [q.options[i], q.options[j]] = [q.options[j], q.options[i]];
                    }
                });
            }
            render();
        }

        window.handleAnswer = (p) => {
            state.scoreE += p;
            if (state.currentQ + 1 < questions.length) {
                state.currentQ++;
                render();
            } else { 
                finishQuiz(); 
            }
        };

        async function finishQuiz() {
            state.view = 'result';
            render();
            state.isSaving = false;
            render();
        }

        window.sendFeedback = async (level) => {
            state.feedbackSent = true;
            state.isSaving = true;
            render();

            const isE = state.scoreE >= 30;
            const payload = {
                name: state.name,
                result: isE ? "Eå‹" : "Iå‹",
                score: state.scoreE,
                accuracy: level,
                timestamp: Date.now()
            };

            if (db && state.user) {
                try {
                    const col = collection(db, 'artifacts', appId, 'public', 'data', 'quizLogs');
                    await addDoc(col, payload);
                } catch (e) { 
                    console.error("Firestore Add Error:", e);
                }
            }

            if (googleSheetUrl) {
                try {
                    await fetch(googleSheetUrl, {
                        method: 'POST',
                        mode: 'no-cors',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                } catch (e) {}
            }
            
            state.isSaving = false;
            render();
        };

        function startAdminListener() {
            if (!db || !state.user) return;
            const col = collection(db, 'artifacts', appId, 'public', 'data', 'quizLogs');
            onSnapshot(col, (snap) => {
                state.logs = snap.docs.map(d => ({ id: d.id, ...d.data() })).sort((a,b)=>b.timestamp - a.timestamp);
                render();
            }, (err) => console.error("Snapshot error:", err));
        }

        render();
    </script>
</body>
</html>
